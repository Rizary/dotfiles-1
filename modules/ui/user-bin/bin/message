#!/bin/sh

MESSAGE_FILE="$XDG_RUNTIME_DIR/message"

nextMessageId() {
    previousId=$(cat $MESSAGE_FILE | tail -n 1 | cut -d ' ' -f 1)
    echo $((previousId + 1))
}

writeMessage() {
    message="$1"
    program="$2"
    messageId=$(nextMessageId)

    echo "$messageId $message" >> $MESSAGE_FILE

    if [ "$program" ]; then
        trap "clearMessage $messageId" EXIT
        $program
    else
        echo $messageId
    fi
}

clearMessage() {
    messageId="$1"
    sed -i "/^$messageId /d" $MESSAGE_FILE
}

[ ! -f $MESSAGE_FILE ] && touch $MESSAGE_FILE

case $1 in
    write) writeMessage "$2" "$3" ;;
    clear) clearMessage "$2" ;;
    *) echo "Usage: $0 [clear <id>|write <message> (program)]";;
esac
